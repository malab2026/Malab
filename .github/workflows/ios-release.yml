name: iOS Release (Unsigned)

on:
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'src/**'
      - 'public/**'
      - 'capacitor.config.ts'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: Create .env file
        run: |
          echo "DATABASE_URL=postgresql://placeholder" > .env
          echo "NEXTAUTH_SECRET=placeholder-secret-for-build" >> .env
          echo "NEXTAUTH_URL=https://placeholder.com" >> .env

      - name: Build Web Assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install --repo-update

      - name: Patch iOS Project for CI (Ad-Hoc Signing)
        run: |
          echo "üõ†Ô∏è Patching Project for Ad-Hoc signing (No certificates required)..."
          python3 << 'EOF'
          import os, re
          path = "ios/App/App.xcodeproj/project.pbxproj"
          if os.path.exists(path):
              with open(path, "r") as f: content = f.read()
              
              # 1. Force Manual Provisioning & Ad-Hoc Identity
              content = content.replace('ProvisioningStyle = Automatic;', 'ProvisioningStyle = Manual;')
              content = content.replace('CODE_SIGN_STYLE = Automatic;', 'CODE_SIGN_STYLE = Manual;')
              
              # Use '-' for Ad-Hoc signing which doesn't require a real identity on macOS
              content = re.sub(r'CODE_SIGN_IDENTITY = "[^"]*";', 'CODE_SIGN_IDENTITY = "-";', content)
              content = re.sub(r'CODE_SIGN_IDENTITY\[sdk=iphoneos\*\] = "[^"]*";', 'CODE_SIGN_IDENTITY[sdk=iphoneos*] = "-";', content)
              
              # 2. Clear Team IDs and Profiles
              content = re.sub(r'DEVELOPMENT_TEAM = [^;]+;', 'DEVELOPMENT_TEAM = "";', content)
              content = re.sub(r'PROVISIONING_PROFILE_SPECIFIER = [^;]+;', 'PROVISIONING_PROFILE_SPECIFIER = "";', content)
              
              # 3. Enable Ad-Hoc signing globally in buildSettings
              if "AD_HOC_CODE_SIGNING_ALLOWED" not in content:
                  content = content.replace('buildSettings = {', 'buildSettings = {\n\t\t\t\tAD_HOC_CODE_SIGNING_ALLOWED = YES;')
              
              with open(path, "w") as f: f.write(content)
              print("‚úÖ pbxproj patched successfully.")
          else:
              print("‚ùå pbxproj not found!")
          EOF

      - name: Build Unsigned App
        run: |
          cd ios/App
          # Using Ad-Hoc signing (-) avoids 'Code 65' and allows framework embedding
          xcodebuild build \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ../../build \
            CODE_SIGNING_ALLOWED=YES \
            CODE_SIGN_IDENTITY="-" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SKIP_INSTALL=NO

      - name: Package artifacts
        run: |
          echo "üìÇ Finding built App.app..."
          APP_PATH=$(find build -name "App.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Error: App.app not found!"
            exit 1
          fi
          mkdir Payload
          cp -r "$APP_PATH" Payload/
          zip -r MALA3EBNA.ipa Payload
          # Create source zip for manual build
          zip -r Malaeb-iOS-Source.zip ios package.json capacitor.config.ts src public

      - name: Upload IPA Task Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MALA3EBNA-IPA-Package
          path: |
            MALA3EBNA.ipa
            Malaeb-iOS-Source.zip
          retention-days: 7

      - name: Get Version
        id: version
        run: echo "version=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/heads/main')
        with:
          tag_name: ios-v${{ steps.version.outputs.version }}
          name: MALA3EBNA iOS v${{ steps.version.outputs.version }}
          body: |
            ## üçé MALA3EBNA - iOS Release (Unsigned)
            
            ### üì• Download Options
            
            1. **MALA3EBNA.ipa** (Unsigned)
               - Use **AltStore** or **Sideloadly** to install this.
            
            2. **Malaeb-iOS-Source.zip** (Source Code)
               - For manual build in Xcode (Mac).
            
            ---
            üèüÔ∏è Built with ‚ù§Ô∏è for football lovers
          files: |
            MALA3EBNA.ipa
            Malaeb-iOS-Source.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
