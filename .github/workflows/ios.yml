name: iOS Validation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: Create .env file
        run: |
          echo "DATABASE_URL=postgresql://placeholder" > .env
          echo "NEXTAUTH_SECRET=placeholder-secret-for-build" >> .env
          echo "NEXTAUTH_URL=https://placeholder.com" >> .env

      - name: Build Web Assets
        run: npm run build
        
      - name: Sync Capacitor to iOS
        run: npx cap sync ios

      - name: Validate iOS Project Structure
        run: |
          echo "‚úÖ Validating iOS project structure..."
          
          # Check if iOS project exists
          if [ ! -d "ios/App" ]; then
            echo "‚ùå iOS project directory not found"
            exit 1
          fi
          
          # Check if app icons exist
          if [ ! -d "ios/App/App/Assets.xcassets/AppIcon.appiconset" ]; then
            echo "‚ùå App icons not found"
            exit 1
          fi
          
          # Check if Info.plist exists and contains correct app name
          if ! grep -q "MALA3EBNA" ios/App/App/Info.plist; then
            echo "‚ùå App name not updated in Info.plist"
            exit 1
          fi
          
          echo "‚úÖ iOS project structure validated successfully!"
          echo "üì± App name: MALA3EBNA"
          echo "üé® Icons: Generated"
          echo "üìã Info.plist: Updated"
          
          # List generated assets
          echo ""
          echo "Generated iOS assets:"
          ls -la ios/App/App/Assets.xcassets/AppIcon.appiconset/ | head -10
