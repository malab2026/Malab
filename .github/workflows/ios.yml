name: iOS Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: Create .env file
        run: |
          echo "DATABASE_URL=postgresql://placeholder" > .env
          echo "NEXTAUTH_SECRET=placeholder-secret-for-build" >> .env
          echo "NEXTAUTH_URL=https://placeholder.com" >> .env

      - name: Build Web Assets
        run: npm run build
        
      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Archive iOS Source Code
        run: |
          echo "๐ฆ Zipping iOS source code..."
          zip -r ios-source-code.zip ios/
          
      - name: Get Version
        id: version
        run: echo "version=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Upload Source Code Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ios-source-v${{ steps.version.outputs.version }}
          name: MALA3EBNA iOS Source v${{ steps.version.outputs.version }}
          body: |
            ## ๐ MALA3EBNA - iOS Source Code
            
            ุจุณุจุจ ูููุฏ Apple ุงูุตุงุฑูุฉุ ุชู ุงุณุชุฎุฑุงุฌ ุงูููุฏ ุงููุตุฏุฑู ููุจูุงุก ูุฏููุงู.
            
            ### ๐๏ธ ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู
            1. ุญูู ููู `ios-source-code.zip`
            2. ูู ุงูุถุบุท ุนูู ุฌูุงุฒ Mac
            3. ุดุบู `pod install` ุฏุงุฎู ูุฌูุฏ `ios/App`
            4. ุงูุชุญ `App.xcworkspace` ูุงุจูู ุงูุชุทุจูู ุจุณูููุฉ!
            
            ### ๐ฅ Download
            Download `ios-source-code.zip` below.
          files: |
            ios-source-code.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
