name: iOS Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: Create .env file
        run: |
          echo "DATABASE_URL=postgresql://placeholder" > .env
          echo "NEXTAUTH_SECRET=placeholder-secret-for-build" >> .env
          echo "NEXTAUTH_URL=https://placeholder.com" >> .env

      - name: Build Web Assets
        run: npm run build
        
      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Build Unsigned IPA (Device)
        run: |
          cd ios/App
          # Clean and Install
          rm -rf Pods
          rm -f Podfile.lock
          pod install --repo-update
          
          # ğŸ©¹ CRITICAL FIX: Patch the CocoaPods script to skip code signing
          # This prevents the "Code 65" error during framework embedding
          find Pods -name "*-frameworks.sh" -exec sed -i '' 's/code_sign_if_enabled/echo "Skipping code signing"/g' {} +
          find Pods -name "*-frameworks.sh" -exec sed -i '' 's/codesign /echo "Skipping codesign" /g' {} +
          
          # Disable signing in project files
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' Pods/Pods.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' Pods/Pods.xcodeproj/project.pbxproj
          
          # Build for Device (iphoneos)
          xcodebuild clean build \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ../../build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING=YES

      - name: Package Unsigned IPA
        run: |
          echo "ğŸ“‚ Finding built App.app..."
          # Note: With Release config and derivedDataPath, it should be in .../build/Build/Products/Release-iphoneos/
          APP_PATH=$(find ../../build -name "App.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Error: App.app not found!"
            exit 1
          fi
          
          echo "âœ… Found App at: $APP_PATH"
          mkdir Payload
          cp -r "$APP_PATH" Payload/
          zip -r App-Unsigned.ipa Payload

      - name: Get Version
        id: version
        run: echo "version=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Upload IPA Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ios-ipa-v${{ steps.version.outputs.version }}
          name: MALA3EBNA iOS Unsigned IPA v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ MALA3EBNA - Unsigned IPA
            
            âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…:** Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù **Unsigned** (ØºÙŠØ± Ù…ÙˆÙ‚Ø¹).
            
            - **Ù„Ø§ ÙŠØ¹Ù…Ù„** Ø¨Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.
            - ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ **ØªÙˆÙ‚ÙŠØ¹ ÙŠØ¯ÙˆÙŠ** Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª Ù…Ø«Ù„ AltStore Ø£Ùˆ Sideloadly.
            
            ### ğŸ“¥ Download
            Download `App-Unsigned.ipa` below.
          files: |
            App-Unsigned.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
